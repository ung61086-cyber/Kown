local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local LP = Players.LocalPlayer

-- ===== STATE =====
local State = {
    Name=false, Box=false, HP=false, Hitbox=false,
}

-- ===== GUI =====
local gui = Instance.new("ScreenGui", LP.PlayerGui)
gui.Name = "XTFF_UI"
gui.ResetOnSpawn = false

local main = Instance.new("Frame", gui)
main.Size = UDim2.fromOffset(560, 320)
main.Position = UDim2.fromScale(0.5,0.5)
main.AnchorPoint = Vector2.new(0.5,0.5)
main.BackgroundColor3 = Color3.fromRGB(20,20,30)
main.BorderSizePixel = 0

local top = Instance.new("TextLabel", main)
top.Size = UDim2.new(1,0,0,40)
top.BackgroundTransparency = 1
top.Text = "XTFF DEMO"
top.TextColor3 = Color3.new(1,1,1)
top.Font = Enum.Font.GothamBold
top.TextScaled = true

local close = Instance.new("TextButton", main)
close.Size = UDim2.fromOffset(32,32)
close.Position = UDim2.new(1,-36,0,4)
close.Text = "X"
close.Font = Enum.Font.GothamBold
close.TextScaled = true
close.BackgroundTransparency = 1
close.TextColor3 = Color3.new(1,1,1)

local left = Instance.new("Frame", main)
left.Size = UDim2.fromOffset(150, 250)
left.Position = UDim2.fromOffset(10, 50)
left.BackgroundTransparency = 1

local function MenuBtn(text, y)
    local b = Instance.new("TextButton", left)
    b.Size = UDim2.fromOffset(130, 40)
    b.Position = UDim2.fromOffset(0, y)
    b.Text = text
    b.Font = Enum.Font.GothamBold
    b.TextScaled = true
    b.BackgroundColor3 = Color3.fromRGB(240,240,240)
    b.TextColor3 = Color3.fromRGB(20,20,20)
    b.BorderSizePixel = 0
    return b
end

local btnPlayer = MenuBtn("PLAYER", 0)

local panels = {}
local function NewPanel()
    local p = Instance.new("Frame", main)
    p.Size = UDim2.fromOffset(260, 240)
    p.Position = UDim2.fromOffset(180, 60)
    p.BackgroundTransparency = 1
    p.Visible = false
    return p
end

panels.PLAYER = NewPanel()

local function Show(name)
    for k,v in pairs(panels) do
        v.Visible = (k==name)
    end
end

local y = 0
local function Toggle(parent, text, key)
    local b = Instance.new("TextButton", parent)
    b.Size = UDim2.new(1,0,0,30)
    b.Position = UDim2.fromOffset(0,y)
    y += 36
    b.BackgroundColor3 = Color3.fromRGB(60,60,60)
    b.TextColor3 = Color3.new(1,1,1)
    b.BorderSizePixel = 0
    b.Font = Enum.Font.Gotham
    b.TextSize = 14

    local function refresh()
        b.Text = text..": "..(State[key] and "ON" or "OFF")
    end
    refresh()

    b.MouseButton1Click:Connect(function()
        State[key] = not State[key]
        refresh()
    end)
end

Toggle(panels.PLAYER,"NAME","Name")
Toggle(panels.PLAYER,"BOX","Box")
Toggle(panels.PLAYER,"HP","HP")
Toggle(panels.PLAYER,"HITBOX","Hitbox")

btnPlayer.MouseButton1Click:Connect(function()
    Show("PLAYER")
end)

Show("PLAYER")

close.MouseButton1Click:Connect(function()
    main.Visible = false
end)

UIS.InputBegan:Connect(function(i,g)
    if g then return end
    if i.KeyCode == Enum.KeyCode.RightShift then
        main.Visible = not main.Visible
    end
end)

-- ===== ESP ENGINE (AN TOÀN – GAME CỦA BẠN) =====
local ESPs = {}

local function createESP(model)
    if ESPs[model] then return end
    if model == LP.Character then return end

    local hrp = model:FindFirstChild("HumanoidRootPart")
    local hum = model:FindFirstChild("Humanoid")
    if not hrp or not hum then return end

    local box = Instance.new("BoxHandleAdornment")
    box.Size = Vector3.new(4,6,2)
    box.AlwaysOnTop = true
    box.Adornee = model
    box.Color3 = Color3.fromRGB(255,0,0)
    box.Transparency = 0.4
    box.Parent = model

    local bb = Instance.new("BillboardGui", model)
    bb.Size = UDim2.fromOffset(120,40)
    bb.StudsOffset = Vector3.new(0,3,0)
    bb.AlwaysOnTop = true

    local name = Instance.new("TextLabel", bb)
    name.Size = UDim2.new(1,0,0.5,0)
    name.BackgroundTransparency = 1
    name.Text = model.Name
    name.TextColor3 = Color3.new(1,1,1)
    name.TextScaled = true

    local hp = Instance.new("TextLabel", bb)
    hp.Position = UDim2.fromScale(0,0.5)
    hp.Size = UDim2.new(1,0,0.5,0)
    hp.BackgroundTransparency = 1
    hp.TextColor3 = Color3.new(0,1,0)
    hp.TextScaled = true

    ESPs[model] = {box=box,bb=bb,name=name,hp=hp,hum=hum}
end

RunService.RenderStepped:Connect(function()
    for _,m in ipairs(workspace:GetChildren()) do
        if m:FindFirstChild("Humanoid") and m:FindFirstChild("HumanoidRootPart") then
            createESP(m)
        end
    end

    for m,data in pairs(ESPs) do
        if m.Parent then
            data.box.Visible = State.Box
            data.bb.Enabled = State.Name or State.HP
            data.name.Visible = State.Name
            data.hp.Visible = State.HP
            data.hp.Text = "HP: "..math.floor(data.hum.Health)
        end
    end
end)