-- HIỂN THỊ SỐ NGƯỜI CHƠI
local countLabel = Instance.new("TextLabel", gui)
countLabel.Size = UDim2.fromOffset(200, 28)
countLabel.Position = UDim2.new(0.5, -100, 0, 6)
countLabel.BackgroundTransparency = 0.3
countLabel.BackgroundColor3 = Color3.fromRGB(20,20,20)
countLabel.TextColor3 = Color3.new(1,1,1)
countLabel.Font = Enum.Font.GothamBold
countLabel.TextScaled = true
countLabel.BorderSizePixel = 0

-- NÚT LOGO MỞ MENU
local openBtn = Instance.new("ImageButton", gui)
openBtn.Size = UDim2.fromOffset(60,60)
openBtn.Position = UDim2.new(0,10,0.5,-30)
openBtn.BackgroundTransparency = 1
openBtn.Image = "rbxassetid://PUT_ID_LOGO_TAI_DAY" -- thay ID ảnh của bạn
openBtn.Visible = false
openBtn.Active = true
openBtn.Draggable = true

local menuVisible = true

-- PHÍM X ẨN / HIỆN MENU
UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.X then
        menuVisible = not menuVisible
        frame.Visible = menuVisible
        openBtn.Visible = not menuVisible
    end
end)

openBtn.MouseButton1Click:Connect(function()
    menuVisible = true
    frame.Visible = true
    openBtn.Visible = false
end)

-- ESP + PLAYER COUNT (CHỈ 1 RenderStepped)
RunService.RenderStepped:Connect(function()
    countLabel.Text = "Players: "..#Players:GetPlayers()

    for plr,data in pairs(ESP_TABLE) do
        local hum = data.hum
        local hrp = data.hrp
        if hum and hum.Health > 0 then
            local pos, on = Camera:WorldToViewportPoint(hrp.Position)
            if on then
                -- SCALE NHỎ
                local scale = math.clamp(900 / pos.Z, 0.3, 1.5)
                local w = 18 * scale
                local h = 30 * scale

                data.nameGui.Enabled = ESP_SETTINGS.Name

                if ESP_SETTINGS.Box then
                    data.box.Size = Vector2.new(w,h)
                    data.box.Position = Vector2.new(pos.X-w/2, pos.Y-h/2)
                    data.box.Visible = true
                else data.box.Visible = false end

                if ESP_SETTINGS.Line then
                    data.line.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
                    data.line.To = Vector2.new(pos.X,pos.Y)
                    data.line.Visible = true
                else data.line.Visible = false end

                if ESP_SETTINGS.Hitbox then
                    data.hitbox.Size = Vector2.new(w+6,h+6)
                    data.hitbox.Position = Vector2.new(pos.X-(w+6)/2, pos.Y-(h+6)/2)
                    data.hitbox.Visible = true
                else data.hitbox.Visible = false end

                if ESP_SETTINGS.HP then
                    local p = hum.Health/hum.MaxHealth
                    local barX = pos.X + w/2 + HP_OFFSET
                    local barY = pos.Y - h/2
                    data.hpBG.Position = Vector2.new(barX, barY)
                    data.hpBG.Size = Vector2.new(HP_WIDTH, h)
                    data.hpFG.Position = Vector2.new(barX, barY + h*(1-p))
                    data.hpFG.Size = Vector2.new(HP_WIDTH, h*p)
                    data.hpBG.Visible = true
                    data.hpFG.Visible = true
                else
                    data.hpBG.Visible = false
                    data.hpFG.Visible = false
                end
            else
                data.box.Visible = false
                data.line.Visible = false
                data.hitbox.Visible = false
                data.hpBG.Visible = false
                data.hpFG.Visible = false
            end
        end
    end
end)