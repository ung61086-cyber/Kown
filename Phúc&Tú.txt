-- IOSVIET ALL IN ONE | FIX DELTA | MOBILE SAFE

---------------- SERVICES ----------------
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local Camera = workspace.CurrentCamera
local LP = Players.LocalPlayer

-- WAIT NHÂN VẬT SPAWN
repeat wait() until LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
local Mouse = LP:GetMouse()

---------------- SETTINGS ----------------
local AimRadius = 130
local AimAssist = false
local SkillAimbot = false
local AutoAttack = false
local ESP_Name = false
local Optimize = false
local WalkOnWater = false

local AttackRange = 18
local WaterPart

---------------- SAFE FOV (DELTA) ----------------
local FOV
local DrawingOK = pcall(function()
    FOV = Drawing.new("Circle")
end)

if DrawingOK then
    FOV.Color = Color3.fromRGB(0,255,0)
    FOV.Thickness = 2
    FOV.NumSides = 80
    FOV.Filled = false
    FOV.Visible = false
end

---------------- FIX LAG ----------------
local function ApplyOptimize(state)
    Optimize = state
    Lighting.GlobalShadows = not state
    Lighting.FogEnd = state and 9e9 or 1000

    for _,v in pairs(Lighting:GetChildren()) do
        if v:IsA("PostEffect") then
            v.Enabled = not state
        end
    end

    for _,v in pairs(workspace:GetDescendants()) do
        if v:IsA("BasePart") then
            if state then
                v.Material = Enum.Material.Plastic
                v.Reflectance = 0
            end
        elseif v:IsA("ParticleEmitter")
        or v:IsA("Trail")
        or v:IsA("Fire")
        or v:IsA("Smoke") then
            v.Enabled = not state
        end
    end
end

---------------- UI SAFE (DELTA) ----------------
local gui = Instance.new("ScreenGui")
gui.Name = "IOSVIET_MENU"
gui.ResetOnSpawn = false
gui.Parent = (gethui and gethui()) or LP:WaitForChild("PlayerGui")

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromOffset(260,420)
frame.Position = UDim2.fromScale(0.5,0.5)
frame.AnchorPoint = Vector2.new(0.5,0.5)
frame.BackgroundColor3 = Color3.fromRGB(25,100,200)
frame.Active = true
frame.Draggable = true

local function button(text,y,cb)
    local b = Instance.new("TextButton",frame)
    b.Size = UDim2.new(1,-20,0,32)
    b.Position = UDim2.new(0,10,0,y)
    b.Text = text
    b.TextColor3 = Color3.new(1,1,1)
    b.BackgroundColor3 = Color3.fromRGB(0,130,255)
    b.BorderSizePixel = 0
    b.MouseButton1Click:Connect(cb)
end

---------------- MENU ----------------
local MenuVisible = true

button("ẨN / HIỆN MENU",20,function()
    MenuVisible = not MenuVisible
    frame.Visible = MenuVisible
end)

button("AIM ASSIST",60,function()
    AimAssist = not AimAssist
    if DrawingOK then FOV.Visible = AimAssist or SkillAimbot end
end)

button("SKILL AIMBOT",100,function()
    SkillAimbot = not SkillAimbot
    if DrawingOK then FOV.Visible = AimAssist or SkillAimbot end
end)

button("AUTO ATTACK",140,function()
    AutoAttack = not AutoAttack
end)

button("ESP NAME",180,function()
    ESP_Name = not ESP_Name
end)

button("WALK ON WATER",220,function()
    WalkOnWater = not WalkOnWater
    if not WalkOnWater and WaterPart then
        WaterPart:Destroy()
        WaterPart = nil
    end
end)

button("FIX LAG",260,function()
    ApplyOptimize(not Optimize)
end)

---------------- FUNCTIONS ----------------
local function getTarget()
    local closest, dist = nil, AimRadius
    for _,m in pairs(workspace:GetChildren()) do
        if m:IsA("Model") and m:FindFirstChild("Humanoid")
        and m:FindFirstChild("Head") and m ~= LP.Character then
            local pos,ons = Camera:WorldToViewportPoint(m.Head.Position)
            if ons then
                local mag = (Vector2.new(pos.X,pos.Y)-Vector2.new(Mouse.X,Mouse.Y)).Magnitude
                if mag < dist then
                    dist = mag
                    closest = m
                end
            end
        end
    end
    return closest
end

local function getTool()
    if not LP.Character then return end
    for _,v in pairs(LP.Character:GetChildren()) do
        if v:IsA("Tool") then return v end
    end
end

local function AutoAttackTarget(t)
    local char = LP.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local thrp = t:FindFirstChild("HumanoidRootPart") or t:FindFirstChild("Head")
    if hrp and thrp and (hrp.Position-thrp.Position).Magnitude <= AttackRange then
        local tool = getTool()
        if tool then tool:Activate() end
    end
end

local function UpdateWalkOnWater()
    if not WalkOnWater then return end
    local char = LP.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    if not WaterPart then
        WaterPart = Instance.new("Part")
        WaterPart.Anchored = true
        WaterPart.CanCollide = true
        WaterPart.Transparency = 1
        WaterPart.Size = Vector3.new(14,1,14)
        WaterPart.Parent = workspace
    end
    WaterPart.Position = hrp.Position - Vector3.new(0,3.2,0)
end

---------------- MAIN LOOP ----------------
RunService.RenderStepped:Connect(function()
    if DrawingOK and FOV then
        FOV.Position = Camera.ViewportSize/2
        FOV.Radius = AimRadius
    end

    for _,m in pairs(workspace:GetChildren()) do
        if m:IsA("Model") and m:FindFirstChild("Humanoid")
        and m:FindFirstChild("Head") and m ~= LP.Character then
            if AutoAttack then AutoAttackTarget(m) end
        end
    end

    if AimAssist or SkillAimbot then
        local t = getTarget()
        if t then
            Camera.CFrame = Camera.CFrame:Lerp(
                CFrame.new(Camera.CFrame.Position, t.Head.Position),
                SkillAimbot and 0.15 or 0.08
            )
        end
    end

    UpdateWalkOnWater()
end)

---------------- TOGGLE MENU ----------------
UIS.InputBegan:Connect(function(i,gp)
    if gp then return end
    if i.KeyCode == Enum.KeyCode.RightShift then
        MenuVisible = not MenuVisible
        frame.Visible = MenuVisible
    end
end)
        if m:IsA("Model") and m:FindFirstChild("Humanoid")
        and m:FindFirstChild("Head") and m ~= LP.Character then

            if ESP_Name then CreateNameESP(m)
            elseif Name_ESP[m] then Name_ESP[m]:Destroy(); Name_ESP[m]=nil end

            if AutoAttack then AutoAttackTarget(m) end
        end
    end

    if AimAssist or SkillAimbot then
        local t = getTarget()
        if t then
            Camera.CFrame = Camera.CFrame:Lerp(
                CFrame.new(Camera.CFrame.Position,t.Head.Position),
                SkillAimbot and 0.2 or 0.1
            )
        end
    end

    UpdateWalkOnWater()
end)

---------------- TOGGLE MENU (PHÍM) ----------------
UIS.InputBegan:Connect(function(i,gp)
    if gp then return end
    if i.KeyCode == Enum.KeyCode.RightShift then
        MenuVisible = not MenuVisible
        frame.Visible = MenuVisible
    end
end)